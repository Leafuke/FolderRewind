<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="FolderRewind.Views.FolderManagerPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:FolderRewind.Models"
    xmlns:converters="using:FolderRewind.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <Page.Resources>
        <!-- 确保这些 Converter 类在 Converters 文件夹下存在 -->
        <converters:BoolToStarIconConverter x:Key="BoolToStarIconConverter"/>
        <converters:BoolToColorConverter x:Key="BoolToColorConverter"/>
        <converters:StringToBitmapConverter x:Key="StringToBitmapConverter"/>
    </Page.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 顶部操作栏 -->
        <!-- 顶部操作栏区域 -->
        <StackPanel Background="{ThemeResource LayerFillColorAltBrush}" BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}" BorderThickness="0,0,0,1">

            <!-- 第一行：配置选择与全局操作 -->
            <Grid Padding="24,12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- 左侧：配置切换 -->
                <StackPanel Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                    <FontIcon Glyph="&#xE713;" FontSize="16" Opacity="0.5"/>
                    <TextBlock x:Uid="FolderManager_CurrentConfig" VerticalAlignment="Center" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    <ComboBox x:Name="ConfigSelector" Width="220" 
                              ItemsSource="{x:Bind Configs, Mode=OneWay}"
                              SelectedItem="{x:Bind CurrentConfig, Mode=TwoWay}"
                              DisplayMemberPath="Name"
                              SelectionChanged="ConfigSelector_SelectionChanged"/>
                    <!-- 配置设置按钮 -->
                    <Button Click="OnConfigSettingsClick" Padding="6" Background="Transparent" BorderThickness="0" x:Uid="FolderManager_ConfigSettingsButton">
                        <FontIcon Glyph="&#xE713;" FontSize="14"/>
                    </Button>
                    <!-- 日志按钮 -->
                    <Button Click="OnOpenLogClick" Padding="6" Background="Transparent" BorderThickness="0" x:Uid="FolderManager_ViewLogButton">
                        <FontIcon Glyph="&#xE756;" FontSize="14"/>
                    </Button>
                </StackPanel>

                <!-- 右侧：全局操作 -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                    <Button x:Name="AddFolderButton">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE710;"/>
                            <TextBlock x:Uid="FolderManager_AddFolder"/>
                            <FontIcon Glyph="&#xE70D;" FontSize="10"/>
                        </StackPanel>
                        <Button.Flyout>
                            <MenuFlyout>
                                <MenuFlyoutItem x:Uid="FolderManager_AddSingleFolder" Icon="Folder" Click="OnAddSingleFolderClick"/>
                                <MenuFlyoutItem x:Uid="FolderManager_AddSubFolders" Icon="List" Click="OnAddSubFoldersClick"/>
                            </MenuFlyout>
                        </Button.Flyout>
                    </Button>
                    <Button x:Name="BackupConfigButton" Style="{ThemeResource AccentButtonStyle}" Click="OnBackupConfigClick">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE896;"/>
                            <TextBlock x:Uid="FolderManager_BackupAll"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>

            <!-- 分割线 -->
            <MenuFlyoutSeparator Margin="24,0"/>

            <!-- 第二行：选中项操作与注释 (Action Bar) -->
            <Grid Padding="24,12" Background="{ThemeResource LayerFillColorDefaultBrush}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <FontIcon Glyph="&#xE8B7;" FontSize="16" Foreground="{ThemeResource AccentFillColorDefaultBrush}"/>
                    <TextBlock x:Uid="FolderManager_SelectedAction" VerticalAlignment="Center" FontWeight="SemiBold"/>
                    <TextBlock Text="{x:Bind FolderList.SelectedItem.(models:ManagedFolder.DisplayName), Mode=OneWay, FallbackValue='(未选择)'}" 
                               VerticalAlignment="Center" Opacity="0.8"/>
                </StackPanel>

                <!-- 中间：注释输入框 (关键新增) -->
                <Grid Grid.Column="1" Margin="24,0" MaxWidth="400" HorizontalAlignment="Left">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock x:Uid="FolderManager_BackupComment" VerticalAlignment="Center" Margin="0,0,8,0" Opacity="0.6"/>
                    <TextBox x:Name="CommentBox" Grid.Column="1" x:Uid="FolderManager_CommentPlaceholder" IsEnabled="{x:Bind BackupSelectedButton.IsEnabled, Mode=OneWay}"/>
                </Grid>

                <!-- 右侧：针对选中项的按钮 -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                    <Button x:Name="BackupSelectedButton" IsEnabled="False" Click="OnBackupSelectedClick" Style="{ThemeResource AccentButtonStyle}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE898;"/>
                            <TextBlock x:Uid="FolderManager_BackupSelected"/>
                        </StackPanel>
                    </Button>

                    <Button x:Name="HistoryButton" IsEnabled="False" Click="OnHistoryClick">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE81C;"/>
                            <TextBlock x:Uid="FolderManager_History"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </StackPanel>

        <!-- 文件夹大列表 -->
        <ListView x:Name="FolderList" Grid.Row="1" Padding="12" 
                  ItemsSource="{x:Bind CurrentConfig.SourceFolders, Mode=OneWay}"
                  SelectionMode="Single" 
                  SelectionChanged="FolderList_SelectionChanged">

            <ListView.ItemTemplate>
                <DataTemplate x:DataType="models:ManagedFolder">
                    <Grid Margin="0,8" Padding="12" Background="{ThemeResource LayerFillColorDefaultBrush}" CornerRadius="8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="200"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- 1. 图片区域 -->
                        <Button Padding="0" CornerRadius="8" Width="72" Height="72" BorderThickness="0" Background="Transparent" 
                                Click="onChangeIconClick" x:Uid="FolderManager_ChangeCover">
                            <Grid>
                                <!-- 默认图标 (当图片为空时显示) -->
                                <Border Background="{ThemeResource SystemControlPageBackgroundChromeLowBrush}" CornerRadius="8">
                                    <FontIcon Glyph="&#xE8B9;" FontSize="32" Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                                </Border>

                                <!-- 真实图片 (覆盖在上面) -->
                                <Image Source="{x:Bind CoverImagePath, Mode=OneWay, Converter={StaticResource StringToBitmapConverter}}" Stretch="UniformToFill"/>
                            </Grid>
                        </Button>

                        <!-- 2. 信息区域 -->
                        <StackPanel Grid.Column="1" Margin="16,0" VerticalAlignment="Center" Spacing="4">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="{x:Bind DisplayName}" Style="{ThemeResource SubtitleTextBlockStyle}"/>
                                <Button x:Uid="FolderManager_FavoriteToggle" Background="Transparent" BorderThickness="0" Padding="4" Click="OnFavoriteToggleClick">
                                    <FontIcon Glyph="{Binding IsFavorite, Converter={StaticResource BoolToStarIconConverter}}"
                                              Foreground="{Binding IsFavorite, Converter={StaticResource BoolToColorConverter}}"/>
                                </Button>
                            </StackPanel>

                            <!-- 路径 (绑定到 Model 的 FullPath) -->
                            <TextBlock Text="{x:Bind FullPath}" Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>

                            <!-- 描述 -->
                            <TextBox Text="{x:Bind Description, Mode=TwoWay}" 
                                     x:Uid="FolderManager_AddDescription"
                                     BorderThickness="0" Background="Transparent" 
                                     Padding="0" Margin="-8,0,0,0"
                                     FontStyle="Italic" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                        </StackPanel>

                        <!-- 3. 状态与时间 -->
                        <StackPanel Grid.Column="2" VerticalAlignment="Center">
                            <TextBlock Text="{x:Bind StatusText}" Foreground="Green" FontWeight="SemiBold"/>
                            <TextBlock Text="{x:Bind LastBackupTime}" FontSize="12" Opacity="0.6"/>
                        </StackPanel>

                        <!-- 4. 操作菜单 -->
                        <Button Grid.Column="3" Background="Transparent" BorderThickness="0" Padding="8">
                            <FontIcon Glyph="&#xE712;"/>
                            <Button.Flyout>
                                <MenuFlyout>
                                    <MenuFlyoutItem x:Uid="FolderManager_OpenFolder" Icon="Folder" Click="OnOpenFolderClick"/>
                                    <MenuFlyoutItem x:Uid="FolderManager_Rescan" Icon="Refresh"/>
                                    <MenuFlyoutSeparator/>
                                    <MenuFlyoutItem x:Uid="FolderManager_RemoveFolder" Icon="Delete" Foreground="Red" Click="OnRemoveFolderClick"/>
                                </MenuFlyout>
                            </Button.Flyout>
                        </Button>
                    </Grid>
                </DataTemplate>
            </ListView.ItemTemplate>
        </ListView>
    </Grid>
</Page>