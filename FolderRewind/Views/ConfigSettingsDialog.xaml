<?xml version="1.0" encoding="utf-8"?>
<ContentDialog
    x:Class="FolderRewind.Views.ConfigSettingsDialog"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:FolderRewind.Models"
    x:Uid="ConfigSettingsDialog"
    DefaultButton="Primary"
    PrimaryButtonClick="OnSaveClick"
    SecondaryButtonClick="OnDeleteClick"
    Style="{StaticResource DefaultContentDialogStyle}">

    <Pivot Height="480" Width="520">
        <!-- 1. 常规设置 -->
        <PivotItem x:Uid="ConfigSettingsDialog_General">
            <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="0,0,12,0">
            <StackPanel Spacing="20" Padding="0,12">
                <TextBox x:Uid="ConfigSettingsDialog_ConfigName" Text="{x:Bind Config.Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

                <StackPanel Spacing="8">
                    <TextBlock x:Uid="ConfigSettingsDialog_ConfigType" FontWeight="SemiBold"/>
                    <ComboBox ItemsSource="{x:Bind ConfigTypesView, Mode=OneWay}"
                             SelectedItem="{x:Bind SelectedConfigType, Mode=TwoWay}"
                             HorizontalAlignment="Stretch" />
                    <TextBlock x:Uid="ConfigSettingsDialog_ConfigTypeDesc" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" TextWrapping="Wrap"/>
                </StackPanel>

                <StackPanel Spacing="8">
                    <TextBlock x:Uid="ConfigSettingsDialog_DestPath" FontWeight="SemiBold"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox x:Name="DestPathBox" x:Uid="ConfigSettingsDialog_DestPathPlaceholder" Text="{x:Bind Config.DestinationPath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                        <Button Grid.Column="1" Margin="8,0,0,0" Click="OnBrowseClick" x:Uid="ConfigSettingsDialog_BrowseButton">
                            <FontIcon Glyph="&#xE8B7;"/>
                        </Button>
                        <Button Grid.Column="2" Margin="8,0,0,0" Click="OnOpenDestinationClick" x:Uid="ConfigSettingsDialog_OpenDestination">
                            <FontIcon Glyph="&#xE8A7;"/>
                        </Button>
                    </Grid>
                    <TextBlock x:Uid="ConfigSettingsDialog_DestPathDesc" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                </StackPanel>

                <StackPanel Spacing="8">
                    <TextBlock x:Uid="ConfigSettingsDialog_ConfigFilePath" FontWeight="SemiBold"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox x:Name="ConfigPathBox" Text="{x:Bind ConfigFilePath, Mode=OneWay}" IsReadOnly="True"/>
                        <Button Grid.Column="1" Margin="8,0,0,0" Click="OnOpenConfigFolderClick" x:Uid="ConfigSettingsDialog_OpenConfigFolder">
                            <FontIcon Glyph="&#xE8B7;"/>
                        </Button>
                        <Button Grid.Column="2" Margin="8,0,0,0" Click="OnOpenConfigFileClick" x:Uid="ConfigSettingsDialog_OpenConfigFile">
                            <FontIcon Glyph="&#xE8A7;"/>
                        </Button>
                    </Grid>
                    <TextBlock x:Uid="ConfigSettingsDialog_ConfigFilePathDesc" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                </StackPanel>

                <StackPanel Spacing="8">
                    <TextBlock x:Uid="ConfigSettingsDialog_Icon"/>
                    <GridView x:Name="IconGrid" SelectionMode="Single" Height="180" ScrollViewer.VerticalScrollBarVisibility="Auto" SelectionChanged="OnIconSelectionChanged">
                        <GridView.ItemTemplate>
                            <DataTemplate>
                                <Border Width="40" Height="40" CornerRadius="4" Background="{ThemeResource LayerFillColorDefaultBrush}">
                                    <FontIcon Glyph="{Binding}" FontSize="20" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                            </DataTemplate>
                        </GridView.ItemTemplate>
                    </GridView>
                </StackPanel>
            </StackPanel>
            </ScrollViewer>
        </PivotItem>

        <!-- 2. 备份策略 -->
        <PivotItem x:Uid="ConfigSettingsDialog_BackupStrategy">
            <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="0,0,12,0">
            <StackPanel Spacing="20" Padding="0,12">
                <!-- 备份模式 -->
                <ComboBox x:Uid="ConfigSettingsDialog_BackupMode" SelectedIndex="{x:Bind ModeSelectedIndex, Mode=TwoWay}" HorizontalAlignment="Stretch">
                    <ComboBoxItem x:Uid="ConfigSettingsDialog_ModeFull"/>
                    <ComboBoxItem x:Uid="ConfigSettingsDialog_ModeIncremental"/>
                    <ComboBoxItem x:Uid="ConfigSettingsDialog_ModeOverwrite"/>
                </ComboBox>

                <!-- 压缩格式 + 算法 -->
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <ComboBox x:Uid="ConfigSettingsDialog_Format" SelectedIndex="{x:Bind FormatSelectedIndex, Mode=TwoWay}" HorizontalAlignment="Stretch" Margin="0,0,8,0">
                        <ComboBoxItem x:Uid="ConfigSettingsDialog_Format7z"/>
                        <ComboBoxItem x:Uid="ConfigSettingsDialog_FormatZip"/>
                    </ComboBox>
                    <ComboBox x:Uid="ConfigSettingsDialog_Method" Grid.Column="1" SelectedIndex="{x:Bind MethodSelectedIndex, Mode=TwoWay}" HorizontalAlignment="Stretch" Margin="8,0,0,0" SelectionChanged="OnMethodSelectionChanged">
                        <ComboBoxItem Content="LZMA2"/>
                        <ComboBoxItem Content="Deflate"/>
                        <ComboBoxItem Content="BZip2"/>
                        <ComboBoxItem Content="zstd"/>
                    </ComboBox>
                </Grid>

                <!-- 压缩等级 -->
                <StackPanel Spacing="4">
                    <TextBlock x:Uid="ConfigSettingsDialog_CompressionLevel"/>
                    <Slider x:Name="CompressionLevelSlider" Minimum="{x:Bind CompressionLevelMin}" Maximum="{x:Bind CompressionLevelMax}" Value="{x:Bind Config.Archive.CompressionLevel, Mode=TwoWay}"/>
                </StackPanel>

                <!-- 保留备份数量 -->
                <NumberBox x:Uid="ConfigSettingsDialog_KeepCount" Value="{x:Bind Config.Archive.KeepCount, Mode=TwoWay}" Minimum="0" SpinButtonPlacementMode="Inline"/>

                <!-- 智能备份链长度（仅增量模式有效） -->
                <StackPanel Spacing="4">
                    <NumberBox x:Uid="ConfigSettingsDialog_MaxSmartChain" Value="{x:Bind Config.Archive.MaxSmartBackupsPerFull, Mode=TwoWay}" Minimum="0" Maximum="100" SpinButtonPlacementMode="Inline"/>
                    <TextBlock x:Uid="ConfigSettingsDialog_MaxSmartChainDesc" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" TextWrapping="Wrap"/>
                </StackPanel>

                <!-- 安全删除 -->
                <ToggleSwitch x:Uid="ConfigSettingsDialog_SafeDelete" IsOn="{x:Bind Config.Archive.SafeDeleteEnabled, Mode=TwoWay}"/>

                <!-- 无变更跳过 -->
                <ToggleSwitch x:Uid="ConfigSettingsDialog_SkipIfUnchanged" IsOn="{x:Bind Config.Archive.SkipIfUnchanged, Mode=TwoWay}"/>

                <!-- CPU 线程数 -->
                <StackPanel Spacing="4">
                    <TextBlock x:Uid="ConfigSettingsDialog_CpuThreads"/>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <NumberBox Value="{x:Bind Config.Archive.CpuThreads, Mode=TwoWay}" Minimum="0" Maximum="128" SpinButtonPlacementMode="Inline" Width="160"/>
                        <TextBlock x:Uid="ConfigSettingsDialog_CpuThreadsDesc" VerticalAlignment="Center" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    </StackPanel>
                </StackPanel>

                <!-- 自定义文件类型处理 -->
                <StackPanel Spacing="8">
                    <ToggleSwitch x:Uid="ConfigSettingsDialog_FileTypeHandling" IsOn="{x:Bind Config.Archive.FileTypeHandlingEnabled, Mode=TwoWay}"/>
                    <TextBlock x:Uid="ConfigSettingsDialog_FileTypeHandlingDesc" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" TextWrapping="Wrap"/>

                    <StackPanel Visibility="{x:Bind Config.Archive.FileTypeHandlingEnabled, Mode=OneWay, Converter={StaticResource BoolToVisConverter}}" Spacing="8">
                        <ListView x:Name="FileTypeRulesList" Height="160" ItemsSource="{x:Bind Config.Archive.FileTypeRules}" BorderThickness="1" BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}">
                            <ListView.ItemTemplate>
                                <DataTemplate x:DataType="models:FileTypeRule">
                                    <Grid ColumnSpacing="8">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="{x:Bind Pattern, Mode=OneWay}" VerticalAlignment="Center"/>
                                        <TextBlock Grid.Column="1" VerticalAlignment="Center" Opacity="0.6">
                                            <Run Text="mx="/>
                                            <Run Text="{x:Bind CompressionLevel, Mode=OneWay}"/>
                                        </TextBlock>
                                        <Button Grid.Column="2" Content="&#xE711;" FontFamily="Segoe MDL2 Assets" Click="OnRemoveFileTypeRuleClick"/>
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                        <Grid ColumnSpacing="8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox x:Name="FileTypePatternBox" x:Uid="ConfigSettingsDialog_FileTypePatternPlaceholder"/>
                            <NumberBox x:Name="FileTypeLevelBox" Grid.Column="1" Value="1" Minimum="0" Maximum="9" SpinButtonPlacementMode="Inline" Width="130"/>
                            <Button Grid.Column="2" x:Uid="ConfigSettingsDialog_AddFileTypeRule" Click="OnAddFileTypeRuleClick"/>
                        </Grid>
                    </StackPanel>
                </StackPanel>
            </StackPanel>
            </ScrollViewer>
        </PivotItem>

        <!-- 3. 还原策略 -->
        <PivotItem x:Uid="ConfigSettingsDialog_RestoreStrategy">
            <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="0,0,12,0">
            <StackPanel Spacing="20" Padding="0,12">
                <!-- 还原前自动备份 -->
                <ToggleSwitch x:Uid="ConfigSettingsDialog_BackupBeforeRestore" IsOn="{x:Bind Config.Archive.BackupBeforeRestore, Mode=TwoWay}"/>

                <!-- 还原白名单 -->
                <StackPanel Spacing="8">
                    <TextBlock x:Uid="ConfigSettingsDialog_RestoreWhitelist" FontWeight="SemiBold"/>
                    <TextBlock x:Uid="ConfigSettingsDialog_RestoreWhitelistDesc" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" TextWrapping="Wrap"/>
                    <ListView Height="160" ItemsSource="{x:Bind Config.Filters.RestoreWhitelist}" BorderThickness="1" BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="{Binding}" VerticalAlignment="Center"/>
                                    <Button Grid.Column="1" Content="&#xE711;" FontFamily="Segoe MDL2 Assets" Click="OnRemoveRestoreWhitelistClick"/>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox x:Name="RestoreWhitelistBox" x:Uid="ConfigSettingsDialog_RestoreWhitelistPlaceholder"/>
                        <Button Grid.Column="1" x:Uid="ConfigSettingsDialog_AddRestoreWhitelist" Margin="8,0,0,0" Click="OnAddRestoreWhitelistClick"/>
                    </Grid>
                </StackPanel>
            </StackPanel>
            </ScrollViewer>
        </PivotItem>

        <!-- 4. 自动化 -->
        <PivotItem x:Uid="ConfigSettingsDialog_Automation">
            <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="0,0,12,0">
            <StackPanel Spacing="20" Padding="0,12">
                <ToggleSwitch x:Uid="ConfigSettingsDialog_AutoBackup" IsOn="{x:Bind Config.Automation.AutoBackupEnabled, Mode=TwoWay}"/>

                <StackPanel Visibility="{x:Bind Config.Automation.AutoBackupEnabled, Mode=OneWay, Converter={StaticResource BoolToVisConverter}}" Spacing="12">
                    <CheckBox x:Uid="ConfigSettingsDialog_RunOnAppStart" IsChecked="{x:Bind Config.Automation.RunOnAppStart, Mode=TwoWay}"/>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock x:Uid="ConfigSettingsDialog_IntervalMinutes" VerticalAlignment="Center"/>
                        <NumberBox Value="{x:Bind Config.Automation.IntervalMinutes, Mode=TwoWay}" MinWidth="300" Minimum="1" Maximum="10080" SpinButtonPlacementMode="Inline" Width="140"/>
                        <TextBlock x:Uid="ConfigSettingsDialog_IntervalMinutesSuffix" VerticalAlignment="Center"/>
                    </StackPanel>
                    <CheckBox x:Uid="ConfigSettingsDialog_ScheduledMode" IsChecked="{x:Bind Config.Automation.ScheduledMode, Mode=TwoWay}"/>

                    <StackPanel Visibility="{x:Bind Config.Automation.ScheduledMode, Mode=OneWay, Converter={StaticResource BoolToVisConverter}}" Spacing="8">
                        <TextBlock x:Name="ScheduleEntriesHeader" FontWeight="SemiBold"/>
                        <TextBlock x:Name="ScheduleEntriesDesc" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" TextWrapping="Wrap"/>
                        <StackPanel x:Name="ScheduleEntriesPanel" Spacing="6"/>
                        <Button x:Name="AddScheduleButton" Click="OnAddScheduleEntryClick">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <FontIcon Glyph="&#xE710;" FontSize="14"/>
                                <TextBlock x:Name="AddScheduleText"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <!-- 连续无变更自动停止 -->
                    <ToggleSwitch x:Uid="ConfigSettingsDialog_StopAfterNoChange" IsOn="{x:Bind Config.Automation.StopAfterNoChangeEnabled, Mode=TwoWay}"/>
                    <StackPanel Orientation="Horizontal" Spacing="8" Visibility="{x:Bind Config.Automation.StopAfterNoChangeEnabled, Mode=OneWay, Converter={StaticResource BoolToVisConverter}}">
                        <TextBlock x:Uid="ConfigSettingsDialog_StopAfterNoChangePrefix" VerticalAlignment="Center"/>
                        <NumberBox Value="{x:Bind Config.Automation.StopAfterNoChangeCount, Mode=TwoWay}" MinWidth="300" Minimum="1" Maximum="100" SpinButtonPlacementMode="Inline" Width="120"/>
                        <TextBlock x:Uid="ConfigSettingsDialog_StopAfterNoChangeSuffix" VerticalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>
            </StackPanel>
            </ScrollViewer>
        </PivotItem>

        <!-- 5. 过滤器 (黑名单) -->
        <PivotItem x:Uid="ConfigSettingsDialog_Filter">
            <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="0,0,12,0">
            <StackPanel Spacing="12" Padding="0,12">
                <TextBlock x:Uid="ConfigSettingsDialog_Blacklist" FontWeight="SemiBold"/>
                <ListView Height="200" ItemsSource="{x:Bind Config.Filters.Blacklist}" BorderThickness="1" BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}">
                    <ListView.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="{Binding}" VerticalAlignment="Center"/>
                                <Button Grid.Column="1" Content="&#xE711;" FontFamily="Segoe MDL2 Assets" Click="OnRemoveBlacklistClick"/>
                            </Grid>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
                <CheckBox x:Uid="ConfigSettingsDialog_UseRegex" IsChecked="{x:Bind Config.Filters.UseRegex, Mode=TwoWay}"/>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBox x:Name="BlacklistBox" x:Uid="ConfigSettingsDialog_BlacklistPlaceholder"/>
                    <Button Grid.Column="1" x:Uid="ConfigSettingsDialog_AddBlacklist" Margin="8,0,0,0" Click="OnAddBlacklistClick"/>
                </Grid>
            </StackPanel>
            </ScrollViewer>
        </PivotItem>
    </Pivot>
</ContentDialog>

